name: 自动定时执行

on:
  schedule:
    - cron: "0,30 * * * *"
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    
    # 依然需要写权限来提交代码
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.20'

      - name: Install dependencies
        run: go mod download

      - name: Build Go Program
        run: go build -o main ./cmd/cmd.go

      - name: Run Go Program
        run: |
          ./main \
          --qw_auth="${{ secrets.QW_AUTH}}" \
          --r18=${{ secrets.R18 || 0}} \
          --tags=${{ secrets.TAGS || '' }} \
          --pic_size="${{ secrets.PIC_SIZE || ''}}" \
          --proxy="${{ secrets.PROXY || ''}}" \
          --direct_proxy=${{ secrets.DIRECT_PROXY || ''}}
        env:
          LOG_LEVEL: debug

      - name: Upload logs
        uses: actions/upload-artifact@v4
        if: always() 
        with:
          name: run-logs
          path: logs/

      # 【替换方案】使用原生 Shell 脚本保活，不依赖第三方 Action
      - name: Prevent repo inactivity
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          # 获取最后一次提交的时间
          last_commit=$(git log -1 --format=%ct)
          current_time=$(date +%s)
          days_diff=$(( ($current_time - $last_commit) / 86400 ))
          
          # 只有超过 50 天未提交才执行提交，避免提交记录过于杂乱
          if [ $days_diff -gt 50 ]; then
            git commit --allow-empty -m "Auto-commit to keep workflow active"
            git push
          else
            echo "Last commit was $days_diff days ago. No keepalive needed."
          fi
